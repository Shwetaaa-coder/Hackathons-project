<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meme Gallery - MemeHub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f0f0;
    }
    header {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #logo {
      font-weight: bold;
      font-size: 24px;
      cursor: pointer;
    }
    nav a {
      color: white;
      margin-left: 20px;
      text-decoration: none;
      font-weight: bold;
    }
    #content {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    ul#memes {
      list-style: none;
      padding: 0;
    }
    ul#memes li {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .meme-text {
      font-size: 18px;
      margin-bottom: 5px;
    }
    .meme-tags {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .meme-actions button {
      margin-right: 5px;
    }
    .comments {
      margin-top: 10px;
      font-size: 14px;
    }
    .comments ul {
      list-style: none;
      padding-left: 0;
    }
    .comments li {
      border-top: 1px solid #eee;
      padding: 5px 0;
    }
    .comment-input {
      margin-top: 5px;
    }
    .comment-input input[type="text"] {
      width: 60%;
      padding: 5px;
      font-size: 14px;
    }
    .comment-input button {
      padding: 5px 10px;
      font-size: 14px;
    }
    .flagged {
      color: red;
      font-weight: bold;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js"></script>
</head>
<body>
  <header>
    <div id="logo" onclick="window.location.href='index.html'">MemeHub</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="gallery.html">Gallery</a>
      <a href="meme-creation.html">Meme Creation Studio</a>
    </nav>
  </header>
  <div id="content">
    <h2>Meme Gallery</h2>
    <ul id="memes"></ul>
  </div>
  <footer style="background-color: #333; padding: 10px; color: white; text-align: center; margin-top: 20px;">
    &copy; 2024 MemeHub. All rights reserved.
  </footer>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBv1mD2brzhfDxgZyjUis6j0XmhsQcPwMI",
      authDomain: "hackathons-project-83560.firebaseapp.com",
      databaseURL: "https://hackathons-project-83560-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hackathons-project-83560",
      storageBucket: "hackathons-project-83560.firebasestorage.app",
      messagingSenderId: "693799285364",
      appId: "1:693799285364:web:3c5b3ea19bf53bd4ce9721",
      measurementId: "G-KJ3HEQ2DWR"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM elements
    const memesList = document.getElementById('memes');

    // User ID for voting
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Basic profanity filter (example)
    const bannedWords = ['badword1', 'badword2', 'badword3'];
    function containsBannedWords(text) {
      const lower = text.toLowerCase();
      return bannedWords.some(word => lower.includes(word));
    }

    // Load memes from Firebase
    function loadMemes() {
      const memesRef = database.ref('memes');
      memesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        memesList.innerHTML = '';
        if (data) {
          Object.entries(data).forEach(([id, meme]) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div class="meme-text">${meme.text}</div>
              <div class="meme-tags">${(meme.tags || []).join(', ')}</div>
              <div class="meme-actions">
                <button data-id="${id}" class="upvote">Upvote</button>
                <button data-id="${id}" class="downvote">Downvote</button>
                <span class="votes" id="votes-${id}">Votes: 0</span>
                <button data-id="${id}" class="flag">Flag/Report</button>
                <span class="flagged" id="flagged-${id}" style="display:none;">Flagged for review</span>
              </div>
              <div class="comments">
                <form data-id="${id}" class="comment-form">
                  <input type="text" maxlength="140" placeholder="Add a comment (max 140 chars)" required />
                  <button type="submit">Comment</button>
                </form>
                <ul id="comments-${id}"></ul>
              </div>
            `;
            memesList.appendChild(li);
          });
          attachEventListeners();
          loadVotes();
          loadFlags();
          loadComments();
        }
      });
    }

    // Attach event listeners to buttons and forms
    function attachEventListeners() {
      document.querySelectorAll('.upvote').forEach(button => {
        button.onclick = debounce(() => handleVote(button.dataset.id, 1), 300);
      });
      document.querySelectorAll('.downvote').forEach(button => {
        button.onclick = debounce(() => handleVote(button.dataset.id, -1), 300);
      });
      document.querySelectorAll('.flag').forEach(button => {
        button.onclick = () => handleFlag(button.dataset.id);
      });
      document.querySelectorAll('.comment-form').forEach(form => {
        form.onsubmit = (e) => {
          e.preventDefault();
          const memeId = form.dataset.id;
          const input = form.querySelector('input[type="text"]');
          const text = input.value.trim();
          if (text === '' || text.length > 140) return;
          if (containsBannedWords(text)) {
            alert('Your comment contains inappropriate language.');
            return;
          }
          handleCommentSubmit(memeId, text);
          input.value = '';
        };
      });
    }

    // Optimistic UI update for voting
    const voteCache = {};
    function handleVote(memeId, voteValue) {
      // Optimistically update UI
      const voteSpan = document.getElementById(`votes-${memeId}`);
      if (!voteSpan) return;
      let currentVotes = parseInt(voteSpan.textContent.replace('Votes: ', '')) || 0;
      if (!voteCache[memeId]) voteCache[memeId] = 0;
      currentVotes = currentVotes - voteCache[memeId] + voteValue;
      voteSpan.textContent = `Votes: ${currentVotes}`;
      voteCache[memeId] = voteValue;

      // Update Firebase
      const voteRef = database.ref(`votes/${memeId}/${userId}`);
      voteRef.set(voteValue);
    }

    // Load votes and update UI
    function loadVotes() {
      const votesRef = database.ref('votes');
      votesRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([memeId, votes]) => {
          const voteCount = Object.values(votes).reduce((acc, val) => acc + val, 0);
          const voteSpan = document.getElementById(`votes-${memeId}`);
          if (voteSpan) voteSpan.textContent = `Votes: ${voteCount}`;
          voteCache[memeId] = 0; // reset cache on load
        });
      });
    }

    // Handle flagging
    function handleFlag(memeId) {
      const flagRef = database.ref(`flags/${memeId}`);
      flagRef.set(true);
      alert('Content flagged for moderation.');
    }

    // Load flags and update UI
    function loadFlags() {
      const flagsRef = database.ref('flags');
      flagsRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([memeId, flagged]) => {
          const flagSpan = document.getElementById(`flagged-${memeId}`);
          if (flagSpan) flagSpan.style.display = flagged ? 'inline' : 'none';
        });
      });
    }

    // Handle comment submission
    function handleCommentSubmit(memeId, text) {
      const commentRef = database.ref(`comments/${memeId}`);
      commentRef.push({ text });
    }

    // Load comments and update UI
    function loadComments() {
      const commentsRef = database.ref('comments');
      commentsRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([memeId, comments]) => {
          const commentsUl = document.getElementById(`comments-${memeId}`);
          if (commentsUl) {
            commentsUl.innerHTML = '';
            Object.values(comments).forEach(comment => {
              const li = document.createElement('li');
              li.textContent = comment.text;
              commentsUl.appendChild(li);
            });
          }
        });
      });
    }

    // Placeholder for AI tag suggestions
    function suggestTags(memeId) {
      alert('AI tag suggestion feature coming soon!');
    }

    // Initial load
    loadMemes();
  </script>
</body>
</html>
